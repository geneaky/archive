1.문제상황 파악
2.원인 분석
3.해결


###### 문제 상황 파악
1. 모니터링 알람 확인
2. 클러스터 상태 확인
3. 노드에서 에러 로그 확인
4. 클라이언트에서 에러 로그 확인

###### 원인 분석
1. 주요 지표 살펴보기
2. 에러 로그 분석

###### 문제 해결
1. 원인 분석을 통해 확인한 원인을 제거하는 과정 진행


# 사례 분석

###### 사례 1. 클러스터의 상태가 green이 아닌 경우

인덱스들 중 누가 yellow, red인지 파악한다.
인덱스들 중 어떤 샤드에 문제가 생겼는지 파악한다.(장애의 범위 파악)


###### 사례 2. 클러스터 문서 색인이 되지 않는경우 ( 403 forbidden)

Disk Usage가 꽉 찾을때

ELS 노드의 디스크 사용량이 100%가 되면 노드의 운영 체제도 정상 동작하지 않기 때문에 ELS에는 디스크 사용량이 일정 수준 이상이 되면 더 이상 색인 하지 않도록 보호하는 장치가 있다.
`cluster.routing.allocation.disk.thredhold_enabled` : 보호장치를 사용 여부 설정
`cluster.routing.allocation.disk.watermark.low` : 기본값 85%, 이 값보다 높아지면 더이상 샤드를 배치하지 않는다.
`cluster.routing.allocation.disk.watermark.high` : 기본값 90%, 이 값보다 높아지면 샤드를 다른 데이터 노드로 옮기기 시작한다.
`cluster.routing.allocation.disk.watermark.flood_stage` : 기본값 95%, 이 값보다 높아지면 더이상 색인 하지 않는다.

데이터노드를 증설하거나 불필요한 인덱스를 삭제해서 디스크 공간을 확보해야한다.
디스크 공간 확보 후 read-only 상태 인덱스를 명시적으로 풀어줘야한다.

###### 사례 3. 간헐적 색인 과정에서 일부 문서 누락되는 경우(특정 시점에)

노드에서 간헐적으로 Rejected 에러가 발생

ELS는 색인/검색 요청을 처리하는 스레드가 존재하고 모든 스레드가 요청을 처리할고 있을 경우를 대비해 큐가 존재한다
> 모든 큐가 꽉 차있을때 발생하는 error > rejected error

1. 데이터 노드를 증설해서 클러스터 처리량을 높인다.
2. 큐를 증설한다. >> 제한적인 상황에서 효과가 있다(평시 처리량은 충분하나 간헐적 많은 양의 요청이 인입되는 경우)
`thread_pool.bulk.queue_size` : 벌크성 색인을 위한 큐 사이즈 설정 프로퍼티

###### 사례 4. 샤드 배치가 되지 않는 경우

노드들이 가지고 있을 수 있는 전체 샤드의 개수에 제한이 존재하기 때문에 이 제한을 넘어가면 더 이상 샤드가 생성되지 않고 인덱스 생성도 불가능하다.

cluster.max_shards_per_node(defaults: 1000) : 위 설정 프로퍼티 

1. 데이터 노드 증설
2. 인덱스 설정 변경
3. cluster.max_shards_per_node 변경

###### 사례 5. CMS GC환경에서 너무 잦은 Old GC가 발생하는 경우

불필요하게 많은 객체들이 old 메모리 영역으로 이동해서 gc가 발생

cms gc의 survivor영역이 이미 가득차서 할당되지 못하는경우 eden에서 old로 바로 할당된다.
> survivor영역을 늘려준다. newratio, survivorratito jvm 튜닝